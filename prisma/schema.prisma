// file: prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  password_hash String
  nama          String
  role          UserRole

  dosenPengampu DosenPengampu[]
  pesertaKelas  PesertaKelas[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DOSEN
  USER
}

model Kurikulum {
  id        Int      @id @default(autoincrement())
  nama      String
  tahun     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mataKuliah    MataKuliah[]
  cpl           CPL[]
  piGroups      PIGroup[]
  AssasmentArea AssasmentArea[]

  @@map("kurikulum")
}

model MataKuliah {
  id      Int    @id @default(autoincrement())
  kode_mk String @unique
  nama    String
  sks     Int
  sifat   String // wajib/ pilihan
  semester Int

  kurikulum    Kurikulum @relation(fields: [kurikulum_id], references: [id])
  kurikulum_id Int

  @@map("mata_kuliah")
}

model PIGroup {
  id        Int    @id @default(autoincrement())
  kode_grup String

  kurikulum    Kurikulum @relation(fields: [kurikulum_id], references: [id])
  kurikulum_id Int

  assasment    AssasmentArea @relation(fields: [assesment_id], references: [id])
  assesment_id Int

  indicators PerformanceIndicator[]

  @@map("pi_group")
}

model PerformanceIndicator {
  id        Int    @id @default(autoincrement())
  deskripsi String @db.Text

  piGroup     PIGroup @relation(fields: [pi_group_id], references: [id])
  pi_group_id Int

  cpl    CPL     @relation(fields: [cpl_id], references: [id])
  cpl_id Int

  cpmkMap CPMK_PI_Map[]

  @@map("performance_indicator")
}

model CPL {
  id        Int    @id @default(autoincrement())
  kode_cpl  String
  deskripsi String @db.Text

  kurikulum    Kurikulum @relation(fields: [kurikulum_id], references: [id])
  kurikulum_id Int
  PerformanceIndicator PerformanceIndicator[]

  @@map("cpl")
}

model AssasmentArea {
  id   Int    @id @default(autoincrement())
  nama String

  kurikulum    Kurikulum @relation(fields: [kurikulum_id], references: [id])
  kurikulum_id Int
  PIGroup      PIGroup[]

  @@map("assasment_area")
}

model TahunAjaran {
  id       Int      @id @default(autoincrement())
  tahun    String
  semester Semester
  kode_neosia     String   @unique
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  kelas Kelas[]

  

  @@unique([tahun, semester])
  @@map("tahun_ajaran")
}

enum Semester {
  GANJIL
  GENAP
}

model Kelas {
  id              Int      @id @default(autoincrement())
  kode_mk         String   
  nama_mk         String   
  nama_kelas      String   
  sks             Int      @default(0) 
  neosia_id       String?  @unique 
  
  // Relasi ke Semester
  tahun_ajaran_id Int
  tahun_ajaran    TahunAjaran @relation(fields: [tahun_ajaran_id], references: [id])
  
  // Relasi ke Dosen & Mahasiswa (Persiapan untuk fitur selanjutnya)
  dosen_pengampu DosenPengampu[]
  peserta_kelas  PesertaKelas[]

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Opsional: Index untuk mempercepat pencarian
  @@index([tahun_ajaran_id])
  @@index([kode_mk])

  @@map("kelas")
  rps RPS[]
}

model DosenPengampu {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  kelas    Kelas @relation(fields: [kelas_id], references: [id])
  kelas_id Int

  dosen    User @relation(fields: [dosen_id], references: [id])
  dosen_id Int

  @@unique([kelas_id, dosen_id])
  @@map("dosen_pengampu")
}

model PesertaKelas {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  kelas     Kelas @relation(fields: [kelas_id], references: [id])
  kelas_id  Int

  nim       String

  nilai_angka Float? // Nilai Akhir
  nilai_huruf String? // Nilai Huruf

  @@unique([kelas_id, nim])
  @@map("peserta_kelas")
  users User[]
  nilais Nilai[]
}

model RPS {
  id                  Int      @id @default(autoincrement())
  // Data Dasar
  deskripsi           String?  @db.Text // Deskripsi Mata Kuliah
  materi_pembelajaran String?  @db.Text // Materi/Bahan Kajian
  pustaka_utama       String?  @db.Text // Referensi Utama
  pustaka_pendukung   String?  @db.Text // Referensi Pendukung
  
  // Status
  is_locked           Boolean  @default(false)
  file_path           String?  // Jika ada file upload manual (opsional)

  // Relasi ke Kelas (One-to-One: 1 Kelas punya 1 RPS spesifik)
  kelas_id            Int      @unique
  kelas               Kelas    @relation(fields: [kelas_id], references: [id])

  // Relasi ke Pertemuan Mingguan
  pertemuan           RPSPertemuan[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("rps")
}

model RPSPertemuan {
  id              Int     @id @default(autoincrement())
  pekan_ke        Int     // Minggu ke-1, ke-2, dst
  kemampuan_akhir String? @db.Text // Sub-CPMK
  bahan_kajian    String? @db.Text // Materi Pembelajaran
  metode_pembelajaran String? @db.Text // Metode (Luring/Daring)
  waktu           String? // Estimasi Waktu (misal: 3x50')
  pengalaman_belajar String? @db.Text // Pengalaman Belajar Mahasiswa
  kriteria_penilaian String? @db.Text // Indikator/Kriteria
  bobot_nilai     Float?  // Bobot (%)

  rps_id          Int
  rps             RPS     @relation(fields: [rps_id], references: [id], onDelete: Cascade)

  @@map("rps_pertemuan")
}

model CPMK {
  id        Int     @id @default(autoincrement())
  kode_cpmk String
  deskripsi String  @db.Text // <-- DITAMBAHKAN
  is_locked Boolean @default(false)

  // kelas    Kelas @relation(fields: [kelas_id], references: [id])
  // kelas_id Int

  komponenPenilaian KomponenPenilaian[]
  piMap             CPMK_PI_Map[]

  @@map("cpmk")
}

model CPMK_PI_Map {
  cpmk    CPMK                 @relation(fields: [cpmk_id], references: [id])
  cpmk_id Int
  pi      PerformanceIndicator @relation(fields: [pi_id], references: [id])
  pi_id   Int

  @@id([cpmk_id, pi_id])
  @@map("cpmk_pi_map")
}

model KomponenPenilaian {
  id    Int    @id @default(autoincrement())
  nama  String
  bobot Float

  cpmk    CPMK @relation(fields: [cpmk_id], references: [id])
  cpmk_id Int

  nilai Nilai[]

  @@map("komponen_penilaian")
}

model Nilai {
  id                    Int    @id @default(autoincrement())
  nilai_angka           Float

  pesertaKelas          PesertaKelas @relation(fields: [peserta_kelas_id], references: [id])
  peserta_kelas_id      Int

  komponenPenilaian     KomponenPenilaian @relation(fields: [komponen_penilaian_id], references: [id])
  komponen_penilaian_id Int

  @@unique([peserta_kelas_id, komponen_penilaian_id])
  @@map("nilai")
}